name: Generate a ClearlyDefined dependencies list for cargo projects

on:
  workflow_call:
    inputs:
      repo:
        type: string
        description: The repository to generate the dependencies for.
        required: true
    outputs:
      dependencies:
        description: The generated dependencies list.
        value: ${{ jobs.generate-deps.outputs.dependencies }}

jobs:
  generate-deps:
    name: Generate ClearyDefined list of dependencies ids.
    runs-on: ubuntu-latest
    outputs:
      dependencies: ${{ steps.generate-deps.outputs.dependencies }}
    steps:
      - uses: actions/checkout@v5
        with:
          repository: ${{ inputs.repo }}
          fetch-depth: 0

      - name: Generate dependencies
        id: generate-deps
        run: |
          cargo tree -e normal --prefix none --no-dedupe \
            | sort -u \
            | grep -v '^[[:space:]]*$' \
            | grep -v zenoh \
            | sed -E 's|([^ ]+) v([^ ]+).*|crate/cratesio/-/\1/\2|' \
            > dependencies.txt

          # Use the multi-line output syntax so newlines are preserved
          echo "dependencies<<EOF" >> $GITHUB_OUTPUT
          cat dependencies.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
