name: Update latest downloads on download.eclipse.org

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to mark as latest (e.g., 1.7.2)'
        required: true
        type: string
      dry-run:
        description: 'Test mode - verify connections and show what would be updated without modifying'
        required: false
        type: boolean
        default: false

jobs:
  update-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v4.1.1

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_PASSPHRASE }}" | ssh-add ~/.ssh/id_ed25519 2>/dev/null || true

      - name: Update latest symlinks on download.eclipse.org
        run: |
          DRY_RUN="${{ inputs.dry-run }}"
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              genie.zenoh@projects-storage.eclipse.org \
              "
              set -e
              VERSION='${{ inputs.version }}'
              BASE_PATH='/home/data/httpd/download.eclipse.org/zenoh'
              UPDATED_COUNT=0
              
              if [ \"\$DRY_RUN\" = \"true\" ]; then
                echo 'üß™ DRY-RUN MODE - Credentials verified, no changes will be made'
                echo ''
              fi
              
              echo 'üîç Scanning for zenoh packages with version \$VERSION...'
              for i in \$BASE_PATH/z*/\$VERSION; do
                if [ -d \"\$i\" ]; then
                  DEST=\$(realpath \$i/../latest)
                  
                  if [ \"\$DRY_RUN\" = \"true\" ]; then
                    FILE_COUNT=\$(find \"\$i\" -type f | wc -l)
                    echo \"üì¶ [DRY-RUN] Would update: \$i (\$FILE_COUNT files) ‚Üí \$DEST\"
                  else
                    echo \"üì¶ Updating: \$i ‚Üí \$DEST\"
                    rm -rf \"\$DEST\"
                    mkdir -p \"\$DEST\"
                    cp -r \"\$i\"/* \"\$DEST/\"
                    echo \"‚úÖ Updated: \$DEST\"
                  fi
                  
                  UPDATED_COUNT=\$((UPDATED_COUNT + 1))
                fi
              done
              
              if [ \$UPDATED_COUNT -eq 0 ]; then
                echo '‚ö†Ô∏è  No packages found for version '\$VERSION
                exit 1
              fi
              
              echo \"\"
              if [ \"\$DRY_RUN\" = \"true\" ]; then
                echo \"üéâ DRY-RUN successful: would update \$UPDATED_COUNT package(s)\"
              else
                echo \"üéâ Successfully updated \$UPDATED_COUNT package(s) to latest\"
              fi
              "

      - name: Verify updates
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              genie.zenoh@projects-storage.eclipse.org \
              "
              set -e
              BASE_PATH='/home/data/httpd/download.eclipse.org/zenoh'
              
              echo 'üîç Verifying latest directories...'
              for latest_dir in \$BASE_PATH/z*/latest; do
                if [ -d \"\$latest_dir\" ]; then
                  FILE_COUNT=\$(find \"\$latest_dir\" -type f | wc -l)
                  echo \"  ‚úÖ \$latest_dir (\$FILE_COUNT files)\"
                fi
              done
              "

      - name: Report completion
        if: always()
        run: |
          echo "Update Latest Downloads Workflow Completed"
          echo "Version: ${{ inputs.version }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
