name: Update latest downloads on download.eclipse.org

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to mark as latest (e.g., 1.7.2)"
        required: true
        type: string
      dry-run:
        description: "Test mode - verify connections and show what would be updated without modifying"
        required: false
        type: boolean
        default: false

jobs:
  update-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Setup SSH key
        run: |
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          mkdir -p ~/.ssh
          echo '#!/bin/sh' > ~/.ssh_askpass
          echo 'echo ${{ secrets.SSH_PASSPHRASE }}' >> ~/.ssh_askpass && chmod +x ~/.ssh_askpass
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | DISPLAY=None SSH_ASKPASS=~/.ssh_askpass ssh-add - >/dev/null
          echo "$SSH_PUBLIC_KEY" > /tmp/id_ed25519.pub
          # Validate SSH key was loaded
          ssh-add -l | grep -q ed25519 || {
            echo "ERROR: Failed to load SSH key"
            exit 1
          }

      - name: Update latest symlinks on download.eclipse.org
        run: |
          DRY_RUN="${{ inputs.dry-run }}"
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -o ControlMaster=auto \
              -o ControlPersist=60s \
              genie.zenoh@projects-storage.eclipse.org \
              "
              set -e
              VERSION='${{ inputs.version }}'
              BASE_PATH='/home/data/httpd/download.eclipse.org/zenoh'
              UPDATED_COUNT=0
              
              # Validate version format (X.Y.Z)
              if ! echo \"\$VERSION\" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
                echo \"ERROR: Invalid version format: \$VERSION (expected X.Y.Z)\"
                exit 1
              fi
              
              if [ \"\$DRY_RUN\" = \"true\" ]; then
                echo 'üß™ DRY-RUN MODE - Credentials verified, no changes will be made'
                echo ''
              fi
              
              echo 'üîç Scanning for zenoh packages with version \$VERSION...'
              for i in \$BASE_PATH/z*/\$VERSION; do
                if [ -d \"\$i\" ]; then
                  DEST=\$(realpath \$i/../latest)
                  
                  # Safety check: validate path is a valid zenoh package symlink
                  if ! echo \"\$DEST\" | grep -qE '/zenoh/z[^/]*/latest$'; then
                    echo \"ERROR: Safety check failed - invalid path: \$DEST\"
                    exit 1
                  fi
                  
                  if [ \"\$DRY_RUN\" = \"true\" ]; then
                    echo \"üîó [DRY-RUN] Would create symlink: \$DEST ‚Üí \$i\"
                  else
                    echo \"üîó Creating symlink: \$DEST ‚Üí \$i\"
                    ln -sfr \"\$i\" \"\$DEST\"
                    echo \"‚úÖ Symlink created: \$DEST\"
                  fi
                  
                  UPDATED_COUNT=\$((UPDATED_COUNT + 1))
                fi
              done
              
              if [ \$UPDATED_COUNT -eq 0 ]; then
                echo '‚ö†Ô∏è  No packages found for version '\$VERSION
                exit 1
              fi
              
              echo \"\"
              if [ \"\$DRY_RUN\" = \"true\" ]; then
                echo \"üéâ DRY-RUN successful: would create \$UPDATED_COUNT symlink(s)\"
              else
                echo \"üéâ Successfully created \$UPDATED_COUNT symlink(s) to latest\"
              fi
              "

      - name: Verify updates
        if: ${{ !inputs.dry-run }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              genie.zenoh@projects-storage.eclipse.org \
              "
              set -e
              BASE_PATH='/home/data/httpd/download.eclipse.org/zenoh'
              
              echo 'üîç Verifying latest symlinks...'
              for latest_link in \$BASE_PATH/z*/latest; do
                if [ -L \"\$latest_link\" ]; then
                  TARGET=\$(readlink \"\$latest_link\")
                  echo \"  ‚úÖ \$latest_link ‚Üí \$TARGET\"
                fi
              done
              "

      - name: Report completion
        if: always()
        run: |
          echo "Update Latest Downloads Workflow Completed"
          echo "Version: ${{ inputs.version }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
