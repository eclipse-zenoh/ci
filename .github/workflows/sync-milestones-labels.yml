name: Sync milestones and labels across all eclipse-zenoh repos

on:
  workflow_dispatch:
    inputs:
      milestone:
        type: string
        description: The milestone to create in zenoh if it does not exist.
        required: false
      due_date:
        type: string
        description: "The milestone due date. This is a timestamp in ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ."
        required: false
      live-run:
        type: boolean
        description: If true, the workflow will perform actual changes. If false, it will run in dry-run mode.
        default: false
        required: false
      repositories:
        type: string
        description: A space-separated list of repositories to sync.
        required: false
        default: "eclipse-zenoh/zenoh-c eclipse-zenoh/zenoh-pico eclipse-zenoh/zenoh-cpp eclipse-zenoh/zenoh-python eclipse-zenoh/zenoh-java eclipse-zenoh/zenoh-kotlin eclipse-zenoh/zenoh-ts eclipse-zenoh/zenoh-plugin-dds eclipse-zenoh/zenoh-plugin-mqtt eclipse-zenoh/zenoh-plugin-ros2dds eclipse-zenoh/zenoh-plugin-webserver eclipse-zenoh/zenoh-backend-filesystem eclipse-zenoh/zenoh-backend-influxdb eclipse-zenoh/zenoh-backend-rocksdb eclipse-zenoh/zenoh-backend-s3 eclipse-zenoh/zenoh-dissector"

defaults:
  run:
    shell: bash

jobs:
  sync-labels:
    name: Sync Zenoh's labels with dependant repositories
    runs-on: ubuntu-latest
    permissions:
      issues: write # required for label/milestone writes if using GITHUB_TOKEN; adjust if using a bot token
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Read required labels
        id: read-labels
        run: |
          if [ ! -f ./pr-checklists.json ]; then
            echo "labels=" >> $GITHUB_OUTPUT
          else
            echo "labels=$(jq -r '.label_checklists | keys | map(@json) | join(" ")' ./pr-checklists.json)" >> $GITHUB_OUTPUT
          fi

      # Checkout the external github-sync repository into a subdirectory
      - uses: actions/checkout@v6
        with:
          repository: pbochynski/github-sync
          ref: 131ac0c6d4a7682b027fb570a421197ed316a5db
          path: github-sync

      - uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install github-sync dependencies
        run: npm ci --prefix github-sync

      - name: Run label sync (live)
        if: ${{ steps.read-labels.outputs.labels && inputs.live-run }}
        run: |
          args=()
          for repo in ${{ inputs.repositories }}; do
            args+=(-t "$repo")
          done
          node github-sync/github-sync.js --token ${{ secrets.BOT_TOKEN_WORKFLOW }} labels \
            -s eclipse-zenoh/zenoh \
            "${args[@]}" \
            -l "${{ steps.read-labels.outputs.labels }}"

      - name: Run label sync (dry-run)
        if: ${{ steps.read-labels.outputs.labels && !inputs.live-run }}
        run: |
          args=()
          for repo in ${{ inputs.repositories }}; do
            args+=(-t "$repo")
          done
          node github-sync/github-sync.js --token ${{ secrets.BOT_TOKEN_WORKFLOW }} labels \
            -s eclipse-zenoh/zenoh \
            "${args[@]}" \
            -l "${{ steps.read-labels.outputs.labels }}" \
            --dry-run

  sync-milestones:
    name: Sync Zenoh's milestones with dependant repositories
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Create milestone in zenoh if it does not exist
        if: ${{ inputs.milestone != '' && inputs.milestone != null }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_TOKEN_WORKFLOW }}
          result-encoding: string
          script: |
            const milestones = await github.rest.issues.listMilestones({
              owner: 'eclipse-zenoh',
              repo:  'zenoh',
            });
            const milestone = milestones.data.find(m => m.title === '${{ inputs.milestone }}');

            if (!milestone) {
              const createParams = {
                owner: 'eclipse-zenoh',
                repo: 'zenoh',
                title: '${{ inputs.milestone }}'
              };
              if ('${{ inputs.due_date }}' && '${{ inputs.due_date }}' !== '') {
                createParams.due_on = '${{ inputs.due_date }}';
              }
              await github.rest.issues.createMilestone(createParams);
            }

      - uses: actions/checkout@v6
        with:
          repository: pbochynski/github-sync
          ref: 131ac0c6d4a7682b027fb570a421197ed316a5db
          path: github-sync

      - uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install github-sync dependencies (milestones)
        run: npm ci --prefix github-sync

      - name: Run milestone sync (live)
        if: ${{ inputs.live-run }}
        run: |
          args=()
          for repo in ${{ inputs.repositories }}; do
            args+=(-t "$repo")
          done
          node github-sync/github-sync.js --token ${{ secrets.BOT_TOKEN_WORKFLOW }} milestones \
            -s eclipse-zenoh/zenoh \
            "${args[@]}"

      - name: Run milestone sync (dry-run)
        if: ${{ !inputs.live-run }}
        run: |
          args=()
          for repo in ${{ inputs.repositories }}; do
            args+=(-t "$repo")
          done
          node github-sync/github-sync.js --token ${{ secrets.BOT_TOKEN_WORKFLOW }} milestones \
            -s eclipse-zenoh/zenoh \
            "${args[@]}" \
            --dry-run
